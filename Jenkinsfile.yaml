pipeline:
  agent:
    any

  environment:
    PGPORT: '5433'
    MYSQL_PORT: '3306'
    CODECOV_TOKEN: '50dd5c2e-4259-4cfa-97a7-b4429e0d179e'

  stages:
    - name: "Before Install"
      steps:
        - script:
            name: Increase size of database drive
            code: |
              sudo mount -o remount,size=50% /var/ramfs

        - script:
            name: Set up the databases
            code: |
              mysql -e 'CREATE DATABASE validator;'
              df -h

              sudo apt-get -y install tabix

              sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/12/main/pg_hba.conf
              sudo service postgresql@12-main restart
              sleep 3
              createuser -e --createdb uta_admin
              createdb -e vvta -O uta_admin
              psql -d vvta -U postgres -c "CREATE USER ta_user WITH PASSWORD 'read_only'"
              wget --output-document=vvta_2023_05_noseq.sql.gz https://www528.lamp.le.ac.uk/vvdata/vvta/vvta_2023_05_noseq.sql.gz
              gunzip -c vvta_2023_05.noseq.psql.gz | psql --quiet vvta
              psql -d vvta -U postgres -c 'GRANT SELECT ON vvta_2023_05.gene TO public;'
              psql -d vvta -U postgres -c 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO ta_user;'
              psql -d vvta -U postgres -c 'GRANT SELECT ON vvta_2023_05.tx_def_summary_v TO ta_user;'
              psql -d vvta -U postgres -c 'GRANT SELECT ON vvta_2023_05.tx_exon_aln_v TO ta_user;'
              psql -d vvta -U postgres -c 'GRANT SELECT ON vvta_2023_05.transcript_lengths_v TO ta_user;'
              psql -d vvta -U postgres -c 'GRANT SELECT ON vvta_2023_05.exon_set TO ta_user;'
              cp configuration/continuous_integration.ini "$HOME"/.variantvalidator
              wget --output-document=validator_2023_08.sql.gz https://www528.lamp.le.ac.uk/vvdata/validator/validator_2023_08.sql.gz
              gunzip validator_2023_08.sql.gz

    - name: "Install"
      steps:
        - script:
            name: Install Dependencies
            code: |
              pip install .

        - script:
            name: Get SeqRepo Data
            code: |
              mkdir "$HOME"/vvta_seqrepo
              wget --output-document="$HOME"/vvta_seqrepo/VV_SR_2023_05.tar https://www528.lamp.le.ac.uk/vvdata/vv_seqrepo/VV_SR_203_05.tar
              cd "$HOME"/vvta_seqrepo/
              tar -xvf VV_SR_2023_05.tar
              cd -

        - script:
            name: Set up Validator Database
            code: |
              mysql validator < validator_2023_08.sql
              rm validator_2023_08.sql

    - name: "Test"
      steps:
        - script:
            name: Run Tests
            code: |
              pytest --cov-report=term --cov=VariantValidator/

    - name: "After Script"
      steps:
        - script:
            name: Upload Code Coverage
            code: |
              codecov
